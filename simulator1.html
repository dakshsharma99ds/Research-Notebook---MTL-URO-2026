<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Active Matter Simulator - Sarah Loos Lab</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f7fa; color:#333; }
header { background:#2b6cb0; color:white; text-align:center; padding:1rem; }
header h1 { margin:0; font-size:1.6rem; }
header p { margin:0.2rem 0 0 0; font-size:0.95rem; }

.container { display:flex; flex-wrap:wrap; padding:2rem; max-width:1200px; margin:auto; gap:2rem; }
.left { flex:1 1 350px; min-width:300px; display:flex; flex-direction:column; gap:1rem; }
.right { flex:1 1 600px; min-width:300px; display:flex; flex-direction:column; gap:1rem; }

.notes { background:white; padding:1rem; border-left:5px solid #2b6cb0; min-height:200px; overflow-y:auto; line-height:1.4; font-size:1rem; }
.controls { text-align:center; margin-top:0.5rem; }
.controls button { margin:5px; padding:0.5rem 1rem; background:#2b6cb0; color:white; border:none; border-radius:5px; cursor:pointer; font-size:0.95rem; }

.canvas-container { width:100%; background:white; border:1px solid #ccc; padding:10px; border-radius:5px; box-sizing:border-box; }
canvas { display:block; width:100%; height:250px; }

.particle-container { position:relative; width:100%; height:350px; background:#e1efff; border-radius:5px; overflow:hidden; border:1px solid #ccc; }

.particle { position:absolute; border-radius:50%; width:12px; height:12px; opacity:0.8; display:flex; justify-content:center; align-items:center; color:white; font-size:8px; font-weight:bold; }
.particle::after {
    content:'';
    position:absolute;
    width:0;
    height:0;
    border-left:4px solid transparent;
    border-right:4px solid transparent;
    border-bottom:8px solid rgb(77, 76, 76);
    top:-6px;
    left:50%;
    transform-origin:50% 50%;
}

#advancedBox { background:#d0e6ff; padding:10px; border:1px solid #2b6cb0; border-radius:5px; font-size:0.9rem; margin-top:1rem; }

label { font-weight:bold; margin-top:1rem; display:block; }
input[type=range] { width:100%; }
.slider-scale { display:flex; justify-content:space-between; font-size:0.85rem; margin-top:2px; }

@media (max-width: 992px){ .container{ flex-direction:column; } .right, .left{ flex:1 1 100%; } canvas{ height:200px;} .particle-container{ height:250px; } }
@media (max-width: 480px){ header h1{ font-size:1.2rem;} header p{ font-size:0.85rem;} .notes{ font-size:0.9rem;} canvas{ height:180px;} .particle-container{ height:200px;} }
</style>
</head>
<body>

<header>
<h1>Active Matter Simulator - Sarah Loos Lab</h1>
<p>Left: Observations & Controls | Right: Charts & Particle Animation</p>
</header>

<div class="container">
  <div class="left">
    <div class="notes" id="explanation"></div>
    <div class="controls">
      <button id="prevBtn">Previous Step</button>
      <button id="nextBtn">Next Step</button>
      <button id="resetBtn">Reset</button>
    </div>

    <div id="advancedBox">
      <strong>Advanced Info:</strong>
      <div id="advancedInfo"></div>
    </div>

    <label for="activitySlider">Activity Level: <span id="activityValue">50</span></label>
    <input type="range" id="activitySlider" min="0" max="100" value="50">
    <div class="slider-scale"><span>0</span><span>25</span><span>50</span><span>75</span><span>100</span></div>

    <label for="interactionSlider">Interaction Strength: <span id="interactionValue">0.05</span></label>
    <input type="range" id="interactionSlider" min="0.01" max="0.2" step="0.01" value="0.05">
    <div class="slider-scale"><span>0.01</span><span>0.05</span><span>0.10</span><span>0.15</span><span>0.20</span></div>
  </div>

  <div class="right">
    <div class="canvas-container">
      <canvas id="statsChart"></canvas>
    </div>
    <div class="particle-container" id="particleContainer"></div>
  </div>
</div>

<script>
// --- Chart Setup ---
const ctx = document.getElementById('statsChart').getContext('2d');
const chart = new Chart(ctx,{
    type:'line',
    data:{ labels:[], datasets:[
        {label:'Cluster Count', data:[], borderColor:'#ff6347', fill:false},
        {label:'Average Energy', data:[], borderColor:'#1e90ff', fill:false}
    ]},
    options:{ responsive:true, animation:{duration:0}, scales:{x:{title:{display:true,text:'Time'}}, y:{title:{display:true,text:'Value'}}} }
});

// --- Particles ---
const container = document.getElementById('particleContainer');
const particles = [];
const numParticles = 40;

function initParticles(){
    container.innerHTML='';
    particles.length=0;
    for(let i=0;i<numParticles;i++){
        const p = document.createElement('div');
        p.className='particle';
        p.x = Math.random()*(container.clientWidth-12);
        p.y = Math.random()*(container.clientHeight-12);
        p.vx = (Math.random()-0.5)*2;
        p.vy = (Math.random()-0.5)*2;
        p.size = 12;
        p.style.width=p.style.height=p.size+'px';
        container.appendChild(p);
        particles.push(p);
    }
}

// --- Steps ---
const steps=[
    {activity:10, interaction:0.01, text:`<b>Step 0: Introduction</b><ul><li>Particles move randomly.</li><li>Observe emergent collective behavior.</li></ul>`},
    {activity:30, interaction:0.03, text:`<b>Step 1: Low Interaction</b><ul><li>Particles weakly interact; motion mostly random.</li></ul>`},
    {activity:50, interaction:0.08, text:`<b>Step 2: Moderate Interaction</b><ul><li>Particles start forming small clusters and align locally.</li></ul>`},
    {activity:70, interaction:0.15, text:`<b>Step 3: High Interaction</b><ul><li>Strong alignment â†’ large clusters emerge, showing collective motion.</li></ul>`}
];
let currentStep=0;

// --- DOM Elements ---
const explanationDiv = document.getElementById('explanation');
const nextBtn = document.getElementById('nextBtn');
const prevBtn = document.getElementById('prevBtn');
const resetBtn = document.getElementById('resetBtn');

const activitySlider=document.getElementById('activitySlider');
const interactionSlider=document.getElementById('interactionSlider');
const activityValue=document.getElementById('activityValue');
const interactionValue=document.getElementById('interactionValue');

function applyStep(stepIndex){
    const s = steps[stepIndex];
    activitySlider.value = s.activity;
    interactionSlider.value = s.interaction;
    activityValue.textContent = s.activity;
    interactionValue.textContent = s.interaction;

    chart.data.labels = [];
    chart.data.datasets[0].data = [];
    chart.data.datasets[1].data = [];
    chart.update();

    initParticles();
    currentStep = stepIndex;
    explanationDiv.innerHTML = s.text;
}

// --- Button Events ---
nextBtn.addEventListener('click', ()=>applyStep(Math.min(currentStep+1, steps.length-1)));
prevBtn.addEventListener('click', ()=>applyStep(Math.max(currentStep-1,0)));
resetBtn.addEventListener('click', ()=>applyStep(0));

activitySlider.addEventListener('input', ()=>{ activityValue.textContent=activitySlider.value; });
interactionSlider.addEventListener('input', ()=>{ interactionValue.textContent=interactionSlider.value; });

// --- Cluster Detection ---
function detectClusters(particles, threshold=30){
    const clusters=[];
    const visited = new Set();
    function dfs(index, cluster){
        visited.add(index);
        cluster.push(index);
        for(let i=0;i<particles.length;i++){
            if(visited.has(i)) continue;
            const dx = particles[i].x - particles[index].x;
            const dy = particles[i].y - particles[index].y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if(dist<threshold) dfs(i, cluster);
        }
    }
    for(let i=0;i<particles.length;i++){
        if(!visited.has(i)){
            const cluster=[];
            dfs(i, cluster);
            clusters.push(cluster);
        }
    }
    return clusters;
}

// --- Simulation Loop ---
let time=0;
function updateSimulation(){
    const activity = parseFloat(activitySlider.value)/50;
    const interaction = parseFloat(interactionSlider.value);

    let avgEnergy=0;
    for(let p of particles){
        p.x += p.vx*activity;
        p.y += p.vy*activity;

        if(p.x<0||p.x>container.clientWidth-12) p.vx*=-1;
        if(p.y<0||p.y>container.clientHeight-12) p.vy*=-1;

        // Interaction
        for(let q of particles){
            if(p===q) continue;
            const dx=q.x-p.x, dy=q.y-p.y;
            const dist=Math.sqrt(dx*dx+dy*dy);
            if(dist<interaction*200){
                p.vx += (q.vx-p.vx)*0.05;
                p.vy += (q.vy-p.vy)*0.05;
            }
        }

        avgEnergy += Math.sqrt(p.vx*p.vx + p.vy*p.vy);
    }
    avgEnergy /= particles.length;

    // Clusters
    const clusters = detectClusters(particles, 30 + interaction*50);
    clusters.forEach((c,i)=>{
        const color = `hsl(${i*50},70%,60%)`;
        c.forEach(idx=>{ particles[idx].style.backgroundColor=color; });
    });

    // Update DOM and rotate arrows
    for(let p of particles){
        p.style.transform = `translate(${p.x}px, ${p.y}px) rotate(${Math.atan2(p.vy,p.vx)}rad)`;
    }

    // Update Chart
    time+=0.1;
    chart.data.labels.push(time.toFixed(1));
    chart.data.datasets[0].data.push(clusters.length);
    chart.data.datasets[1].data.push(avgEnergy.toFixed(2));
    if(chart.data.labels.length>50){
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
        chart.data.datasets[1].data.shift();
    }
    chart.update();

    // Update Advanced Info
    document.getElementById('advancedInfo').innerHTML=
        `Time: ${time.toFixed(1)}<br>`+
        `Clusters: ${clusters.length}<br>`+
        `Average Energy: ${avgEnergy.toFixed(2)}<br>`+
        `Activity Level: ${activitySlider.value}<br>`+
        `Interaction Strength: ${interactionSlider.value}`;

    requestAnimationFrame(updateSimulation);
}

// --- Initialize ---
applyStep(0);
updateSimulation();
</script>

</body>
</html>
